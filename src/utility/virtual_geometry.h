#pragma once

struct VirtualGeometry
{
private:
	// stores data of meshlet building
	struct MeshletDataTable
	{
		std::vector<uint32_t> vertex;
		std::vector<uint8_t>	index;
	};
	struct MyMeshlet
	{
		Meshlet meshlet;
		std::set<std::pair<uint32_t, uint32_t>> boundaries;			// edges on the boundary
		std::unordered_map<uint32_t, uint32_t> adjacentWeight;	// index of adjacent meshlets in array -> number of shared edges
	};

private:
	const StaticMesh* m_pBaseMesh = nullptr;
	std::vector<MeshletDataTable> m_meshletTable;			// meshlet table for different LODs
	std::vector<std::vector<MyMeshlet>> m_meshlets;		// meshlets of different LODs
	std::vector<uint32_t> m_virtualIndex;							// maps real index to virtual index based on vertex positions

private:
	// fill structure used in METIS
	// _lod: LOD of meshlets of the graph
	void _FillCSR(
		uint32_t _lod, 
		std::vector<uint32_t>& _xadj, 
		std::vector<uint32_t>& _adjncy, 
		std::vector<uint32_t>& _adjwgt) const;

	// There may be some vertices that share same positions but store different information,
	// but in this case we only want to differentiate them based on their positions,
	// i.e. if 2 vertices are close enough, it should be treated as the same vertex,
	// so i create this function,
	// _realIndex: vertex index in Static Mesh
	// return virtual index used to compare if the 2 vertices are same
	uint32_t _IdentifyVertexBasedOnPosition(uint32_t _realIndex) const;

	// Find boundary of the meshlet, fill boundaries
	void _FindMeshletBoundary(
		const Meshlet& _meshlet, 
		const std::vector<uint32_t>& _meshletVertexIndex, 
		const std::vector<uint8_t>& _meshletLocalIndex,
		std::set<std::pair<uint32_t, uint32_t>>& _boundaries) const;

	// Find how many edges shared by meshlet pair, fill adjacentWeight
	void _RecordMeshletConnections(uint32_t _lod);

	// Divide meshlet into groups based on edges they shader
	// _lod: lod of meshlets to group
	// _meshletGroups: index of meshlets in a group
	void _DivideMeshletGroup(
		uint32_t _lod, 
		std::vector<std::vector<uint32_t>>& _meshletGroups);

	// Simplify triangles in meshlet groups
	// _meshlets: meshlets that divided into a group
	// _outIndex: indices that build simplified triangles
	void _SimplifyGroupTriangles(
		const std::vector<Meshlet>& _meshlets,
		std::vector<uint32_t>& _outIndex);

	// Build new meshlets from simplified triangles in the group 
	// _index: new set of index generated by _SimplifyGroupTriangles
	// _meshletVertexIndex: meshlet vertex that points to the vertex in static mesh
	// _meshletLocalIndex: local index points to the vertex in meshlet
	// _meshlet: output meshlet
	void _BuildMeshletFromGroupTriangles(
		const std::vector<uint32_t>& _index,
		std::vector<uint32_t>& _meshletVertexIndex,
		std::vector<uint8_t>& _meshletLocalIndex,
		std::vector<Meshlet>& _meshlet);

public:
	void PresetStaticMesh(const StaticMesh& _original);
	void Init();
};